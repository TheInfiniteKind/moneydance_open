<!--
build file for ant
http://jakarta.apache.org/ant/index.html
-->

<project name="moneydance" default="all" basedir=".">
  <property name="version"  value="1.0"/>
  <property name="src" value="."/>
  <property file="${src}/user.properties"/>
  <property name="build" value="./build"/>
  <property name="lib" value="../lib"/>
  <property name="extprivkeyfile" value="${src}/priv_key"/>
  <property name="extpubkeyfile" value="${src}/pub_key"/>
  <property name="privkeyid" value="99"/>

  <property name="build.sysclasspath" value="ignore" /> <!-- suppress "includeantruntime not set" messages from ant -->
  <property name="build.compiler"  value="modern"/>
  <property name="build.compiler.fulldepend"  value="true"/>
  <property name="dist"  value="../dist"/>
  <property name="install"  value="${user.home}/.moneydance/fmodules"/>
  <property name="tmp"  value="../tmp"/>
  <property name="debug"  value="on"/>
  <property name="optimize"  value="off"/>

  <path id="classpath">
    <pathelement path="../lib/moneydance.jar"/>
    <pathelement path="../lib/moneydance2017.jar"/> <!-- If you absolutely MUST use something that isn't in the exposed MD API then put a moneydance.jar file from Moneydance 2015 or higher here.  But, please don't. -->
    <pathelement path="../lib/mdadmin.jar"/> <!-- Since mdadmin has a StringUtils, it needs to come after moneydance.jar -->
    <pathelement path="../lib/jfreechart-1.0.13.jar"/>
    <pathelement path="../lib/jcommon-1.0.12.jar"/>
  </path>

  <target name="init">
    <mkdir dir="${dist}"/>
    <mkdir dir="${build}"/>

    <!--
    Generic macro for building a specific feature.
    -->
    <macrodef name="build-mxt">
      <attribute name="feature" description="name of the mxt file"/>
      <attribute name="javac-target" />
      <attribute name="javac-source" />
      <sequential>
        <delete file="${dist}/@{feature}.mxt" />
        <!--
          since there isn't separate build directories for each feature,
          delete anything that wasn't from this feature already
        -->
        <delete includeemptydirs="true">
          <fileset dir="${build}">
            <include name="**" />
            <exclude name="com/moneydance/modules/features/@{feature}/**"/>
          </fileset>
        </delete>
        <!-- copy all non java files for this feature -->
        <copy todir="${build}">
          <fileset dir="${src}">
            <include name="com/moneydance/modules/features/@{feature}/**" />
            <include name="license.txt" />
            <exclude name="**/*.java" /><!-- exclude source files -->
            <exclude name="**/contact.*" />
          </fileset>
        </copy>
        <!-- move license and contact to book of mxt -->
        <copy todir="${build}">
          <fileset dir="${src}/com/moneydance/modules/features/@{feature}">
            <include name="contact.*" />
          </fileset>
        </copy>
        <javac target="@{javac-target}" source="@{javac-source}" srcdir="${src}" debug="${debug}" optimize="${optimize}"
          classpathref="classpath"  destdir="${build}"
          includes="com/moneydance/modules/features/@{feature}/**"
          includeAntRuntime="false" />
        <jar destfile="${dist}/@{feature}.mxt">
          <fileset dir="${build}" includes="**" />
        </jar>
      	<!-- delegating signing to another target to allow bypass when in eclipse -->
      	<antcall target="sign" inheritall="true" inheritrefs="true">
      	  <param name="feature" value="@{feature}" />
      	</antcall>
      </sequential>
    </macrodef>
  </target>


  <target name="findandreplace-compile" depends="init">
    <javac  target="1.6" source="1.6" compiler="modern" srcdir="${src}" debug="${debug}" optimize="${optimize}"
            classpathref="classpath"  destdir="${build}"  classpath="${lib}/TableLayout-bin-jdk1.5-2009-08-26.jar"
            includeantruntime="false"
            bootclasspath="${java.home}/lib/rt.jar"
            includes="
                com/moneydance/modules/features/findandreplace/**/*.java
                info/clearthought/layout/**"/>
    <jar destfile="${dist}/findandreplace.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/findandreplace/meta_info.dict
             com/moneydance/modules/features/findandreplace/*.properties
             com/moneydance/modules/features/findandreplace/*.xml
             com/moneydance/modules/features/findandreplace/*.properties.xml
             com/moneydance/modules/features/findandreplace/*.gif
             com/moneydance/modules/features/findandreplace/*.png
             com/moneydance/modules/features/findandreplace/*.jpg
             com/moneydance/modules/features/findandreplace/*.jpeg"/>
      <fileset dir="${build}" includes="
             com/moneydance/modules/features/findandreplace/**/*.class
             info/clearthought/layout/**"/>
      <zipgroupfileset dir="${lib}/" includes="TableLayout-bin-jdk1.5-2009-08-26.jar"/>
    </jar>
  </target>

  <target name="findandreplace" depends="findandreplace-compile">
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="findandreplace"/>
      <arg line="${dist}/findandreplace.mxt"/>
    </java>
      <delete file="${dist}/findandreplace.mxt" verbose="true" failonerror="false" />
    <move file="${src}/s-findandreplace.mxt" tofile="${dist}/findandreplace.mxt" verbose="true" failonerror="false" />
    <!--<copy file="${dist}/findandreplace.mxt" tofile="${install}/findandreplace.mxt" verbose="true" failonerror="false" />-->
  </target>


  <target name="mikebalpred" depends="init">
    <javac target="1.6"  source="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
           classpathref="classpath"  destdir="${build}"
           includes="com/moneydance/modules/features/mikebalpred/**"/>

    <jar destfile="${dist}/mikebalpred.mxt">
      <fileset dir="${src}" includes="
               com/moneydance/modules/features/mikebalpred/meta_info.dict
               com/moneydance/modules/features/mikebalpred/*.gif
               com/moneydance/modules/features/mikebalpred/*.jpg
               com/moneydance/modules/features/mikebalpred/english.dict
               com/moneydance/modules/features/mikebalpred/*.jpeg"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/mikebalpred/**"/>
    </jar>

    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
        <arg value="signextjar"/>
        <arg value="${extprivkeyfile}"/>
        <arg value="${privkeyid}"/>
        <arg value="mikebalpred"/>
        <arg line="${dist}/mikebalpred.mxt"/>
    </java>
    <move file="${src}/s-mikebalpred.mxt" tofile="${dist}/mikebalpred.mxt"/>
  </target>

  <target name="autorates" depends="init">
    <javac target="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath"  destdir="${build}"
      includes="com/moneydance/modules/features/autorates/**"/>

    <jar destfile="${dist}/autorates.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/autorates/meta_info.dict
             com/moneydance/modules/features/autorates/*.gif
             com/moneydance/modules/features/autorates/*.png
             com/moneydance/modules/features/autorates/*.jpg
             com/moneydance/modules/features/autorates/*.jpeg"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/autorates/**"/>
    </jar>

    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="autorates"/>
      <arg line="${dist}/autorates.mxt"/>
    </java>
    <delete file="${dist}/autorates.mxt"/>
    <move file="${src}/s-autorates.mxt" tofile="${dist}/autorates.mxt"/>
  </target>

  <target name="priceui" depends="init" description="build the priceui.mxt">
    <build-mxt feature="priceui" javac-source="1.8" javac-target="1.8" />
    <!--<copy file="${dist}/priceui.mxt" tofile="${install}/priceui.mxt" verbose="true" failonerror="false" />-->
  </target>

  <target name="debtinsights" depends="init" description="build the debtinsights.mxt">
    <build-mxt feature="debtinsights" javac-source="1.8" javac-target="1.8" />
    <!--<copy file="${dist}/debtinsights.mxt" tofile="${install}/debtinsights.mxt" verbose="true" failonerror="false" />-->
  </target>

  <target name="detailedbudget" depends="init" description="build the detailedbudget.mxt">
    <build-mxt feature="detailedbudget" javac-source="1.8" javac-target="1.8" />
    <!--<copy file="${dist}/debtinsights.mxt" tofile="${install}/debtinsights.mxt" verbose="true" failonerror="false" />-->
  </target>

  <target name="yahooqt" depends="init" description="build the yahooqt.mxt">
    <build-mxt feature="yahooqt" javac-source="1.5" javac-target="1.5" />
    <!--<copy file="${dist}/yahooqt.mxt" tofile="${install}/yahooqt.mxt" verbose="true" failonerror="false" />-->
  </target>

  <target name="txfexport" depends="init" description="build the TXF export extension">
    <build-mxt feature="txfexport" javac-source="1.6" javac-target="1.6" />
    <!--<copy file="${dist}/txfexport.mxt" tofile="${install}/txfexport.mxt" verbose="true" failonerror="false" />-->
  </target>


  <target name="miscdebug" depends="init">
    <javac encoding="utf8" target="1.6" source="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
           classpathref="classpath"  destdir="${build}"
           includeantruntime="false"
           includes="com/moneydance/modules/features/miscdebug/**"/>
    <jar destfile="${dist}/miscdebug.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/miscdebug/meta_info.dict
             com/moneydance/modules/features/miscdebug/icon-debug.gif"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/miscdebug/**"/>
    </jar>
    <java newenvironment="true"
          classpathref="classpath"
          classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="miscdebug"/>
      <arg line="${dist}/miscdebug.mxt"/>
    </java>
    <move file="${src}/s-miscdebug.mxt" tofile="${dist}/miscdebug.mxt"/>
  </target>


  <target name="ratios-compile" depends="init">
    <javac target="1.5" source="1.5" compiler="modern" srcdir="${src}" debug="${debug}" optimize="${optimize}"
              classpathref="classpath"  destdir="${build}"
      includes="
        com/moneydance/modules/features/ratios/**/*.java
        "/>
    <jar destfile="${dist}/ratios.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/ratios/meta_info.dict
             com/moneydance/modules/features/ratios/*.properties
             com/moneydance/modules/features/ratios/*.xml
             com/moneydance/modules/features/ratios/*.properties.xml
             com/moneydance/modules/features/ratios/*.gif
             com/moneydance/modules/features/ratios/*.png
             com/moneydance/modules/features/ratios/*.jpg
             com/moneydance/modules/features/ratios/*.jpeg"/>
      <fileset dir="${build}" includes="
             com/moneydance/modules/features/ratios/**/*.class
             "/>
    </jar>
  </target>

  <target name="ratios" depends="ratios-compile">
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="ratios"/>
      <arg line="${dist}/ratios.mxt"/>
    </java>
      <delete file="${dist}/ratios.mxt" verbose="true" failonerror="false" />
    <move file="${src}/s-ratios.mxt" tofile="${dist}/ratios.mxt" verbose="true" failonerror="false" />
    <copy file="${dist}/ratios.mxt" tofile="${install}/ratios.mxt" verbose="true" failonerror="false" />
  </target>


  <target name="yahoofx" depends="init">
    <javac encoding="utf8" target="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath"  destdir="${build}"
      includes="com/moneydance/modules/features/yahoofx/**"/>
    <jar destfile="${dist}/yahoofx.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/yahoofx/meta_info.dict
             com/moneydance/modules/features/yahoofx/*.png
             com/moneydance/modules/features/yahoofx/*.gif"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/yahoofx/**"/>
    </jar>
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="yahoofx"/>
      <arg line="${dist}/yahoofx.mxt"/>
    </java>
    <move file="${src}/s-yahoofx.mxt" tofile="${dist}/yahoofx.mxt"/>
  </target>


  <target name="balpred" depends="init">
    <javac encoding="utf8" target="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath"  destdir="${build}"
      includes="com/moneydance/modules/features/balpred/**"/>
    <jar destfile="${dist}/balpred.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/balpred/meta_info.dict
             com/moneydance/modules/features/balpred/english.dict
             com/moneydance/modules/features/balpred/*.png
             com/moneydance/modules/features/balpred/*.gif"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/balpred/**"/>
    </jar>
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="balpred"/>
      <arg line="${dist}/balpred.mxt"/>
    </java>
    <move file="${src}/s-balpred.mxt" tofile="${dist}/balpred.mxt"/>
  </target>

  <target name="cmdline" depends="init">
    <javac encoding="utf8" target="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath"  destdir="${build}"
      includes="com/moneydance/modules/features/cmdline/**"/>
    <jar destfile="${dist}/cmdline.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/cmdline/meta_info.dict
             com/moneydance/modules/features/cmdline/*.png
             com/moneydance/modules/features/cmdline/*.gif"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/cmdline/**"/>
    </jar>
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="cmdline"/>
      <arg line="${dist}/cmdline.mxt"/>
    </java>
    <move file="${src}/s-cmdline.mxt" tofile="${dist}/cmdline.mxt"/>
  </target>

  <target name="console" depends="init">
    <javac encoding="utf8" target="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath"  destdir="${build}"
      includes="com/moneydance/modules/features/console/**"/>
    <jar destfile="${dist}/console.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/console/meta_info.dict
             com/moneydance/modules/features/console/*.png
             com/moneydance/modules/features/console/*.gif"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/console/**"/>
    </jar>
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="console"/>
      <arg line="${dist}/console.mxt"/>
    </java>
    <move file="${src}/s-console.mxt" tofile="${dist}/console.mxt"/>
  </target>

  <target name="moneyPie" depends="init">
      <javac encoding="utf8" target="1.7" source="1.7" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath" destdir="${build}"
      classpath="${lib}/moneyPieSupport.jar"
      includes="com/moneydance/modules/features/moneyPie/**"/>
      <jar destfile="${dist}/moneyPie.mxt">
          <manifest>
              <attribute name="Built-By" value="RagingCoders"/>
          </manifest>

          <fileset dir="${src}" includes="
          com/moneydance/modules/features/moneyPie/meta_info.dict
          com/moneydance/modules/features/moneyPie/images/*.gif
          com/moneydance/modules/features/moneyPie/images/*.jpg
          com/moneydance/modules/features/moneyPie/images/*.jpeg
          net/java/balloontip/images/*.png"/>
          <fileset dir="${build}" includes="com/moneydance/modules/features/moneyPie/**"/>
      	  <zipgroupfileset dir="${lib}" includes="moneyPieSupport.jar" />
      </jar>
      <java newenvironment="true"
          classpathref="classpath"
          classname="com.moneydance.admin.KeyAdmin">
          <arg value="signextjar"/>
          <arg value="${extprivkeyfile}"/>
          <arg value="${privkeyid}"/>
          <arg value="moneyPie"/>
          <arg line="${dist}/moneyPie.mxt"/>
      </java>
      <move file="${src}/s-moneyPie.mxt" tofile="${dist}/moneyPie.mxt"/>
  </target>


  <target name="txtimport" depends="init">
    <javac target="1.6" source="1.6" srcdir="${src}" debug="${debug}" optimize="${optimize}"
      classpathref="classpath"  destdir="${build}"
      includes="com/moneydance/modules/features/txtimport/**"/>

    <jar destfile="${dist}/txtimport.mxt">
      <fileset dir="${src}" includes="
             com/moneydance/modules/features/txtimport/meta_info.dict
             com/moneydance/modules/features/txtimport/*.gif
             com/moneydance/modules/features/txtimport/*.png
             com/moneydance/modules/features/txtimport/*.jpg
             com/moneydance/modules/features/txtimport/english.dict
             com/moneydance/modules/features/txtimport/*.jpeg"/>
      <fileset dir="${build}" includes="com/moneydance/modules/features/txtimport/**"/>
    </jar>

    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="txtimport"/>
      <arg line="${dist}/txtimport.mxt"/>
    </java>
    <delete file="${dist}/txtimport.mxt"/>
    <move file="${src}/s-txtimport.mxt" tofile="${dist}/txtimport.mxt"/>
  </target>

  <target name="pythonsample" depends="init">
    <jar destfile="${dist}/pythonsample.mxt">
      <fileset dir="${src}/python_sample_extension" includes="**"/>
    </jar>
    <java newenvironment="true"
          classpathref="classpath"
          classname="com.moneydance.admin.KeyAdmin">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${extprivkeyid}"/>
      <arg value="pythonsample"/>
      <arg line="${dist}/pythonsample.mxt"/>
    </java>
    <move file="${src}/s-pythonsample.mxt" tofile="${dist}/pythonsample.mxt"/>
  </target>


  <target name="featureloader" depends="init" description="build the featureloader.mxt">
    <build-mxt feature="featureloader" javac-source="1.5" javac-target="1.5" />
  </target>

  <target name="clean" depends="init" description="remove built artifacts">
    <delete dir="${dist}" />
    <delete dir="${build}" />
  </target>

  <target name="sign" description="sign the mxt" unless="dont_sign">
  	<fail unless="feature" message="Please specify property feature" />
    <java newenvironment="true"
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin"
      fork="true">
      <arg value="signextjar"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${privkeyid}"/>
      <arg value="${feature}"/>
      <arg line="${dist}/${feature}.mxt"/>
    </java>
    <move file="./s-${feature}.mxt" tofile="${dist}/${feature}.mxt"/>
  </target>

  <target name="genkeys">
    <java
      classpathref="classpath"
      classname="com.moneydance.admin.KeyAdmin">
      <arg value="genkey"/>
      <arg value="${extprivkeyfile}"/>
      <arg value="${extpubkeyfile}"/>
    </java>
  </target>

  <target name="all" depends="yahooqt,balpred,console,cmdline,yahoofx,txtimport,featureloader,findandreplace,pythonsample"/>

</project>
